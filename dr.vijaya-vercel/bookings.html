<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bookings & Intake</title>
<link rel="stylesheet" href="styles/styles.css">
<script defer src="scripts/utils.js"></script>
<script defer src="scripts/db.js"></script>
<script defer src="scripts/models.js"></script>
<script defer src="scripts/calc.js"></script>
<script defer>
document.addEventListener('DOMContentLoaded', async () => {
  guardSessionOrRedirect(); setupThemeToggle(); showRoleBadge();
  await window.DB.ensureReady();
  renderToday();
  const q = new URLSearchParams(location.search).get('q')||'';
  if(q) document.getElementById('search').value = q;
  await searchPatients(q);
  document.getElementById('createBooking').addEventListener('click', createBooking);
  document.getElementById('calcEDD').addEventListener('click', ()=>{
    const lmp = document.getElementById('lmp').value;
    document.getElementById('edd').value = window.Calc.eddFromLmp(lmp) || '';
  });
  paintMiniCalendar();
});
async function renderToday(){
  const list = await window.Models.getTodayBookings();
  const wrap = document.getElementById('todayList'); wrap.innerHTML='';
  list.forEach(b=>{
    const li=document.createElement('div'); li.className='row';
    li.innerHTML = `<div><strong>${b.slotType}</strong> â€¢ ${b.date} ${b.time}</div>
      <div class="muted">${b.patient?.name||''} (${b.patient?.phone||''})</div>
      <div class="row-actions">
        <a class="btn sm" href="scan.html?bookingId=${b.id}">Open Scan</a>
        <button class="btn sm ghost" onclick="sendReminder('${b.id}')">WhatsApp</button>
      </div>`;
    wrap.appendChild(li);
  });
}
async function sendReminder(bookingId){
  const b = await window.Models.getBookingWithPatient(bookingId);
  const msg = encodeURIComponent(`Dear ${b.patient?.name||'Patient'}, reminder for your ${b.slotType} on ${b.date} at ${b.time}. Prep: ${window.Models.prepFor(b.slotType)}. Clinic: Dr. Vijayaâ€™s FMC.`);
  const wa = `https://wa.me/${(b.patient?.phone||'')}/?text=${msg}`; window.open(wa,'_blank'); await window.Models.markReminder(bookingId); toast('Reminder link opened'); renderToday();
}
async function searchPatients(q){
  const res = await window.Models.searchPatients(q);
  const wrap=document.getElementById('patients'); wrap.innerHTML='';
  res.forEach(p=>{
    const d=document.createElement('div'); d.className='row';
    d.innerHTML=`<div><strong>${p.name}</strong> â€¢ ${p.phone||''}</div><div class="muted">${p.address||''}</div>
      <div class="row-actions"><button class="btn sm" onclick='pickPatient(${JSON.stringify(p).replaceAll(\"'\",\"&#39;\")})'>Select</button></div>`;
    wrap.appendChild(d);
  });
}
window.pickPatient = (p)=>{ patientId.value=p.id; patientName.value=p.name; phone.value=p.phone||''; };
async function createBooking(){
  const patientIdVal = patientId.value || await window.Models.quickCreatePatient({name:patientName.value.trim(),phone:phone.value.trim(),dob:dob.value,address:address.value.trim()});
  const pregId = await window.Models.ensurePregnancy(patientIdVal, lmp.value, edd.value);
  const data = {pregnancyId: pregId, slotType: slotType.value, date: date.value, time: time.value, referrer: referrer.value.trim(), consentCaptured: consent.checked, fee: Number(fee.value||0), status:'confirmed', paymentMode: mode.value, paymentRef: payRef.value.trim()};
  await window.Models.createBooking(data); toast('Booking saved'); renderToday();
}
function paintMiniCalendar(){
  const el=document.getElementById('miniCal'); const d=new Date(); const y=d.getFullYear(), m=d.getMonth();
  monthBadge.textContent = d.toLocaleString('en',{month:'long',year:'numeric'});
  const days = new Date(y,m+1,0).getDate(); const today=new Date().toISOString().slice(0,10);
  for(let i=1;i<=days;i++){ const cell=document.createElement('div'); cell.className='day'; cell.textContent=i; const key=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`; if(key===today) cell.classList.add('is-today'); el.appendChild(cell); }
}
</script>
</head>
<body><body class="bg-purple">

  <header class="topbar">
    <div class="brand-inline"><img src="assets/logo.png" class="logo-sm"><strong>Bookings & Intake</strong></div>
    <div class="topbar-actions">
      <input id="search" class="input sm" placeholder="Search name/phone" onkeydown="if(event.key==='Enter')location.search='?q='+encodeURIComponent(this.value)">
      <span id="roleBadge" class="badge"></span>
      <button id="themeToggle" class="btn ghost">ðŸŒ“</button>
      <a class="btn ghost" href="dashboard.html">Home</a>
    </div>
  </header>

  <main class="grid cols">
    <section class="card">
      <h3>Create booking</h3>
      <input type="hidden" id="patientId">
      <label>Patient name</label><input id="patientName" class="input">
      <label>Phone</label><input id="phone" class="input" inputmode="tel">
      <label>DOB</label><input id="dob" class="input" type="date">
      <label>Address</label><input id="address" class="input">

      <div class="divider"></div>
      <h4>Obstetric</h4>
      <label>LMP</label><input id="lmp" class="input" type="date">
      <div class="row-inline"><label>EDD</label><input id="edd" class="input"><button class="btn" id="calcEDD">Calc</button></div>

      <div class="divider"></div>
      <label>Slot type</label>
      <select id="slotType" class="input">
        <option>NT (11â€“13+6)</option><option>Detailed Anomaly (18â€“22)</option><option>Growth + Dopplers (28â€“36)</option><option>Targeted Scan</option><option>Fetal Echo</option><option>Early Viability</option><option>Procedures (CVS/Amnio/IUT)</option>
      </select>
      <div class="row-inline"><label>Date</label><input id="date" class="input" type="date"><label>Time</label><input id="time" class="input" type="time"></div>
      <label>Referral source</label><input id="referrer" class="input">
      <label>Consent captured?</label><input id="consent" type="checkbox">
      <div class="divider"></div>
      <h4>Payments</h4>
      <div class="row-inline"><label>Amount</label><input id="fee" class="input" inputmode="decimal" placeholder="0"><label>Mode</label><select id="mode" class="input"><option>Cash</option><option>UPI</option><option>Card</option></select></div>
      <label>Ref #</label><input id="payRef" class="input">
      <button id="createBooking" class="btn primary mt-2">Save booking</button>
    </section>

    <section class="card">
      <h3>Todayâ€™s list</h3>
      <div id="todayList" class="list"></div>
    </section>

    <section class="card">
      <div class="row-inline" style="justify-content:space-between"><strong>Schedule</strong><span class="badge" id="monthBadge"></span></div>
      <div class="calendar" id="miniCal"></div>
      <h3 class="mt-2">Patients</h3>
      <div id="patients" class="list"></div>
    </section>
  </main>

  <footer class="fixed-footer">
  Powered by Onestop AI Services. All rights reserved.
</footer>

</body>
</html>