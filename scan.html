<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Obstetric Ultrasound</title>
<link rel="stylesheet" href="styles/styles.css">
<script defer src="scripts/utils.js"></script>
<script defer src="scripts/db.js"></script>
<script defer src="scripts/models.js"></script>
<script defer src="scripts/reports.js"></script>
<script defer src="scripts/pcpndt.js"></script>
<script defer>
let bookingId, booking, scan;
document.addEventListener('DOMContentLoaded', async () => {
  guardSessionOrRedirect(); setupThemeToggle(); showRoleBadge();
  await window.DB.ensureReady();
  bookingId = new URLSearchParams(location.search).get('bookingId');
  if (!bookingId) { toast('No bookingId'); return; }
  booking = await window.Models.getBookingWithPatient(bookingId);
  document.getElementById('caseHdr').textContent = `${booking.slotType} ‚Ä¢ ${booking.date} ${booking.time} ‚Ä¢ ${booking.patient?.name||''}`;
  scan = await window.Models.ensureScanForBooking(bookingId, booking.slotType);
  bindFields(scan);
  document.querySelectorAll('[data-tab]').forEach(btn=>{ btn.onclick = ()=>switchTab(btn.dataset.tab); });
  saveScan.onclick = async ()=>{ const payload = collectFields(); await window.Models.updateScan(scan.id, payload); toast('Saved'); };
  finalize.onclick = async ()=>{
    const current = collectFields();
    const checklistOk = window.Models.checkMandatory(current.type, current.checklist);
    if(!checklistOk){ toast('Complete mandatory checklist before finalizing','error'); return; }
    const html = window.Reports.buildDetailedAnomalyReport(booking, current);
    const pdfBlob = await window.Reports.htmlToPdfBlob(html);
    await window.Models.finalizeScan(scan.id, {reportHtml: html, reportPdfBlob: pdfBlob});
    await window.PCPNDT.generateFormFForScan(scan.id);
    toast('Report finalized & Form-F generated');
  };
  viewReport.onclick = async ()=>{ const s=await window.Models.getScan(scan.id); if(!s?.reportHtml){ toast('No report yet','error'); return; } window.Reports.previewHtml(s.reportHtml); };
  viewFormF.onclick = async ()=>{ const f=await window.PCPNDT.getFormFForScan(scan.id); if(!f){ toast('Form-F not found','error'); return; } window.PCPNDT.previewFormF(f); };
});
function switchTab(name){ document.querySelectorAll('.tab').forEach(t=>t.classList.add('hide')); document.getElementById(name).classList.remove('hide'); document.querySelectorAll('[data-tab]').forEach(b=>b.classList.toggle('active', b.dataset.tab===name)); }
function bindFields(s){ type.value=s.type||'Detailed Anomaly (18‚Äì22)'; (s.checklist?.requiredPlanes||[]).forEach(v=>document.querySelector(`input[name="planes"][value="${v}"]`)?.click()); const b=s.biometry||{}; ['CRL','BPD','HC','AC','FL','EFW'].forEach(k=>{ document.getElementById(k).value = b[k]??''; }); const d=s.dopplers||{}; ['UA','MCA','CPR'].forEach(k=>{ document.getElementById(k).value = d[k]??''; }); }
function collectFields(){ const planes=[...document.querySelectorAll('input[name="planes"]:checked')].map(x=>x.value); const biometry=Object.fromEntries(['CRL','BPD','HC','AC','FL','EFW'].map(k=>[k, num(document.getElementById(k).value)])); const dopplers=Object.fromEntries(['UA','MCA','CPR'].map(k=>[k, num(document.getElementById(k).value)])); return {type: type.value, checklist:{requiredPlanes:planes,notes: chkNotes.value}, biometry, dopplers}; }
function num(v){ const n=Number(v); return Number.isFinite(n)? n : null; }
</script>
</head>
<body><body class="bg-pink">

<header class="topbar">
  <div class="brand-inline"><img src="assets/logo.png" class="logo-sm"><strong>Obstetric Ultrasound</strong></div>
  <div class="topbar-actions">
    <span id="caseHdr" class="badge"></span>
    <span id="roleBadge" class="badge"></span>
    <button id="themeToggle" class="btn ghost">üåì</button>
    <a class="btn ghost" href="dashboard.html">Home</a>
  </div>
</header>
<section class="card">
  <h3>Scan Workbench</h3>
  <div id="scanEmpty" class="empty">
    <img src="assets/illus/empty-state.svg" alt="No scan illustration" width="200">
    <p>Select a booking to start a scan.</p>
  </div>
</section>

<main class="card">
  <div class="tabs">
    <button class="tab-btn active" data-tab="Checklist">Checklist</button>
    <button class="tab-btn" data-tab="Biometry">Biometry</button>
    <button class="tab-btn" data-tab="Dopplers">Dopplers</button>
    <button class="tab-btn" data-tab="Report">Report</button>
  </div>
  <div id="Checklist" class="tab">
    <label>Scan type</label>
    <select id="type" class="input">
      <option>NT (11‚Äì13+6)</option><option selected>Detailed Anomaly (18‚Äì22)</option><option>Growth + Dopplers (28‚Äì36)</option><option>Early Viability</option><option>Fetal Echo</option>
    </select>
    <div class="divider"></div>
    <h4>Mandatory planes (ISUOG-aligned subset)</h4>
    <div class="chips">
      <label><input type="checkbox" name="planes" value="HC"> Head circumference</label>
      <label><input type="checkbox" name="planes" value="AC"> Abdominal circumference</label>
      <label><input type="checkbox" name="planes" value="FL"> Femur length</label>
      <label><input type="checkbox" name="planes" value="Spine"> Spine sagittal</label>
      <label><input type="checkbox" name="planes" value="4CH"> 4-chamber heart</label>
      <label><input type="checkbox" name="planes" value="3VV"> 3-vessel view</label>
    </div>
    <label>Notes</label>
    <textarea id="chkNotes" class="input" rows="3" placeholder="Additional observations"></textarea>
  </div>
  <div id="Biometry" class="tab hide">
    <div class="grid two">
      <label>CRL (mm)<input id="CRL" class="input"></label>
      <label>BPD (mm)<input id="BPD" class="input"></label>
      <label>HC (mm)<input id="HC" class="input"></label>
      <label>AC (mm)<input id="AC" class="input"></label>
      <label>FL (mm)<input id="FL" class="input"></label>
      <label>EFW (g)<input id="EFW" class="input"></label>
    </div>
    <p class="muted">Auto-calc GA/percentiles stub present.</p>
  </div>
  <div id="Dopplers" class="tab hide">
    <div class="grid two">
      <label>UA PI<input id="UA" class="input"></label>
      <label>MCA PI<input id="MCA" class="input"></label>
      <label>CPR (MCA/UA)<input id="CPR" class="input"></label>
    </div>
  </div>
  <div id="Report" class="tab hide">
    <div class="row-inline"><button id="saveScan" class="btn">Save</button><button id="finalize" class="btn primary">Finalize Report</button><button id="viewReport" class="btn ghost">Preview Report</button><button id="viewFormF" class="btn ghost">View Form-F</button></div>
    <p class="muted">Report finalization is blocked until mandatory checklist fields are complete. All PDFs show ‚ÄúSex not disclosed‚Äù.</p>
  </div>
</main>
<footer class="fixed-footer">
  Powered by Onestop AI Services. All rights reserved.
</footer>
</body>
</html>